<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive Music System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 40px; }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .btn {
            background: #1DB954;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #1ed760; }
        .btn:disabled { background: #666; cursor: not-allowed; }
        .hidden { display: none; }
        .loading { opacity: 0.6; pointer-events: none; }
        #weather-info { margin: 20px 0; }
        #playlist {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }
        #playlist::-webkit-scrollbar {
            width: 8px;
        }
        #playlist::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        #playlist::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #playlist::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .track-item {
            padding: 10px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .track-item:hover {
            background: #e0e0e0;
        }
        .track-item.playing {
            background: #1DB954;
            color: white;
        }
        #player {
            background: #282828;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        #player-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        #album-art {
            width: 64px;
            height: 64px;
            border-radius: 5px;
            margin-right: 15px;
            background: #404040;
        }
        #track-info {
            flex: 1;
        }
        #track-name {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        #track-artist {
            color: #b3b3b3;
            font-size: 0.9em;
        }
        #player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }
        #player-controls button {
            background: transparent;
            border: 1px solid white;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #player-controls button:hover {
            background: rgba(255,255,255,0.1);
        }
        #player-controls .play-btn {
            width: 50px;
            height: 50px;
            font-size: 1.5em;
        }
        #progress-bar {
            width: 100%;
            height: 4px;
            background: #404040;
            border-radius: 2px;
            cursor: pointer;
            margin: 10px 0;
        }
        #progress {
            height: 100%;
            background: #1DB954;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }
        #time-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #b3b3b3;
        }
        #volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        #volume-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: #404040;
            border-radius: 2px;
        }
        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
        }
        #playlist-selector {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 15px 0;
        }
        .playlist-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .playlist-checkbox:hover {
            background: #f0f0f0;
        }
        .playlist-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .playlist-checkbox label {
            cursor: pointer;
            flex: 1;
        }
        .playlist-image {
            width: 40px;
            height: 40px;
            border-radius: 3px;
            margin-right: 10px;
            background: #ddd;
        }
        .select-all-btn {
            background: #666;
            font-size: 0.9em;
            padding: 8px 15px;
        }
        .activity-btn {
            flex: 1;
            min-width: 140px;
            background: #666;
            transition: all 0.3s ease;
        }
        .activity-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .slider-container {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .slider-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .parameter-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        .parameter-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
            transition: background 0.2s;
        }
        .parameter-slider::-webkit-slider-thumb:hover {
            background: #1ed760;
        }
        .parameter-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
            border: none;
        }
    </style>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ Adaptive Music System</h1>
            <p>Weather-Aware Music Recommendations</p>
        </header>
        <div class="card">
            <h2>Spotify Authentication</h2>
            <div id="login-section">
                <p>Connect your Spotify account to get started</p>
                <button class="btn" onclick="login()">Login with Spotify</button>
            </div>
            <div id="logout-section" class="hidden">
                <p>Connected to Spotify</p>
                <button class="btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="app-section" class="hidden">
            <div class="card">
                <h2>Current Context</h2>
                <div id="weather-info">
                    <p>Loading weather data...</p>
                </div>
            </div>

            <div class="card">
                <h2>Activity Selection</h2>
                <p>Choose your current activity for personalized recommendations</p>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                    <button class="btn activity-btn" data-activity="relaxing" onclick="selectActivity('relaxing')" style="background: #1DB954;">Relaxing</button>
                    <button class="btn activity-btn" data-activity="working out" onclick="selectActivity('working out')">Working Out</button>
                    <button class="btn activity-btn" data-activity="focusing" onclick="selectActivity('focusing')">Focusing</button>
                    <button class="btn activity-btn" data-activity="party" onclick="selectActivity('party')">Party</button>
                    <button class="btn activity-btn" data-activity="commuting" onclick="selectActivity('commuting')">Commuting</button>
                    <button class="btn activity-btn" data-activity="studying" onclick="selectActivity('studying')">Studying</button>
                </div>
            </div>

            <div class="card">
                <h2>Fine-tune Parameters</h2>
                <p>Adjust weights for different factors in music scoring</p>
                <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px;">
                    <div class="slider-container">
                        <label for="weatherWeight">Weather Influence: <span id="weatherValue">60%</span></label>
                        <input type="range" id="weatherWeight" min="0" max="100" value="60" class="parameter-slider" oninput="updateSliderValue('weather', this.value)">
                    </div>
                    <div class="slider-container">
                        <label for="genreWeight">Learned Genre Preference: <span id="genreValue">100%</span></label>
                        <input type="range" id="genreWeight" min="0" max="150" value="100" class="parameter-slider" oninput="updateSliderValue('genre', this.value)">
                    </div>
                    <div class="slider-container">
                        <label for="moodWeight">Mood (Valence) Influence: <span id="moodValue">100%</span></label>
                        <input type="range" id="moodWeight" min="0" max="200" value="100" class="parameter-slider" oninput="updateSliderValue('mood', this.value)">
                    </div>
                    <div class="slider-container">
                        <label for="energyWeight">Energy Matching: <span id="energyValue">100%</span></label>
                        <input type="range" id="energyWeight" min="0" max="200" value="100" class="parameter-slider" oninput="updateSliderValue('energy', this.value)">
                    </div>
                    <div class="slider-container">
                        <label for="playlistWeight">Playlist Genre Bonus: <span id="playlistValue">100%</span></label>
                        <input type="range" id="playlistWeight" min="0" max="150" value="100" class="parameter-slider" oninput="updateSliderValue('playlist', this.value)">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Music Player</h2>
                <div id="player" class="hidden">
                    <div id="player-info">
                        <img id="album-art" src="" alt="Album Art">
                        <div id="track-info">
                            <div id="track-name">No track playing</div>
                            <div id="track-artist"></div>
                        </div>
                    </div>
                    <div id="player-controls">
                        <button onclick="previousTrack()" title="Previous">‚èÆ</button>
                        <button class="play-btn" onclick="togglePlay()" id="play-pause-btn" title="Play/Pause">‚ñ∂</button>
                        <button onclick="nextTrack()" title="Next">‚è≠</button>
                    </div>
                    <div id="progress-bar" onclick="seek(event)">
                        <div id="progress"></div>
                    </div>
                    <div id="time-info">
                        <span id="current-time">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                    <div id="volume-control">
                        <span>üîä</span>
                        <input type="range" id="volume-slider" min="0" max="100" value="50" oninput="setVolume(this.value)">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Select Source Playlists</h2>
                <p>Choose playlists to generate weather-aware recommendations from</p>
                <button class="btn" onclick="loadUserPlaylists()" id="load-playlists-btn">Load My Playlists</button>
                <button class="btn select-all-btn" onclick="toggleSelectAll()" id="select-all-btn" style="display:none">Select All</button>
                <div id="playlist-selector" class="hidden"></div>
            </div>

            <div class="card">
                <h2>Generate Weather-Aware Playlist</h2>
                <p>Create a playlist tailored to your current weather and mood</p>
                <button class="btn" onclick="generatePlaylist()" id="generate-btn">Generate Playlist</button>
                <div id="playlist" class="hidden"></div>
            </div>
        </div>
    </div>
    <script>
        // Check authentication status on page load
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();

                if (data.authenticated) {
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('logout-section').classList.remove('hidden');
                    document.getElementById('app-section').classList.remove('hidden');
                    loadWeather();
                } else {
                    document.getElementById('login-section').classList.remove('hidden');
                    document.getElementById('logout-section').classList.add('hidden');
                    document.getElementById('app-section').classList.add('hidden');
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
        }

        async function login() {
            const response = await fetch('/api/auth/login');
            const data = await response.json();
            window.location.href = data.auth_url;
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            location.reload();
        }

        let currentActivity = 'relaxing'; // Default activity

        // Parameter weights (as percentages of default values)
        let parameterWeights = {
            weather: 60,
            genre: 100,
            mood: 100,
            energy: 100,
            playlist: 100
        };

        function updateSliderValue(param, value) {
            parameterWeights[param] = parseInt(value);

            // Update display
            const displayValue = param === 'weather' ? value + '%' : value + '%';
            document.getElementById(param + 'Value').textContent = displayValue;

            console.log(`Parameter updated: ${param} = ${value}%`);
        }

        async function loadWeather() {
            try {
                const response = await fetch('/api/weather/current');
                const data = await response.json();

                const weatherDiv = document.getElementById('weather-info');
                if (data.error) {
                    weatherDiv.innerHTML = `<p>Weather data unavailable: ${data.error}</p>`;
                } else {
                    const timeOfDay = data.weather.time_of_day || 'afternoon';
                    const localTime = data.weather.local_time || 'N/A';
                    const timeEmoji = {
                        'morning': 'üåÖ',
                        'afternoon': '‚òÄÔ∏è',
                        'evening': 'üåÜ',
                        'night': 'üåô'
                    }[timeOfDay] || '‚è∞';

                    weatherDiv.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <p><strong>Location:</strong> ${data.location.city}, ${data.location.country}</p>
                            <p><strong>Local Time:</strong> ${timeEmoji} ${localTime}</p>
                            <p><strong>Time of Day:</strong> ${timeOfDay.charAt(0).toUpperCase() + timeOfDay.slice(1)}</p>
                            <p><strong>Temperature:</strong> ${data.weather.temperature}¬∞F</p>
                            <p><strong>Conditions:</strong> ${data.weather.description}</p>
                            <p><strong>Humidity:</strong> ${data.weather.humidity}%</p>
                        </div>
                    `;

                    // Store weather data globally for use in recommendations
                    window.currentWeather = data.weather;
                }
            } catch (error) {
                console.error('Failed to load weather:', error);
                document.getElementById('weather-info').innerHTML = '<p>Failed to load weather data</p>';
            }
        }

        function selectActivity(activity) {
            currentActivity = activity;

            // Update button styles
            document.querySelectorAll('.activity-btn').forEach(btn => {
                if (btn.dataset.activity === activity) {
                    btn.style.background = '#1DB954';
                } else {
                    btn.style.background = '#666';
                }
            });

            console.log(`Activity selected: ${activity}`);
        }

        let userPlaylists = [];

        async function loadUserPlaylists() {
            const btn = document.getElementById('load-playlists-btn');
            const selectorDiv = document.getElementById('playlist-selector');

            btn.disabled = true;
            btn.textContent = 'Loading...';

            try {
                const response = await fetch('/api/user/playlists');
                const data = await response.json();

                if (data.error) {
                    selectorDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                    return;
                }

                userPlaylists = data.items || [];

                if (userPlaylists.length === 0) {
                    selectorDiv.innerHTML = '<p>No playlists found</p>';
                    return;
                }

                let html = '';
                userPlaylists.forEach((playlist, i) => {
                    const imageUrl = playlist.images && playlist.images.length > 0
                        ? playlist.images[0].url
                        : '';
                    html += `
                        <div class="playlist-checkbox">
                            <input type="checkbox" id="playlist-${i}" value="${playlist.id}" onchange="updatePlaylistSelection()">
                            ${imageUrl ? `<img src="${imageUrl}" class="playlist-image" alt="Playlist cover">` : '<div class="playlist-image"></div>'}
                            <label for="playlist-${i}">${playlist.name} (${playlist.tracks.total} tracks)</label>
                        </div>
                    `;
                });

                selectorDiv.innerHTML = html;
                selectorDiv.classList.remove('hidden');
                document.getElementById('select-all-btn').style.display = 'inline-block';

            } catch (error) {
                console.error('Failed to load playlists:', error);
                selectorDiv.innerHTML = '<p>Failed to load playlists. Please try again.</p>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Reload Playlists';
            }
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('#playlist-selector input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });

            updatePlaylistSelection();
        }

        function updatePlaylistSelection() {
            const checkedCount = document.querySelectorAll('#playlist-selector input[type="checkbox"]:checked').length;
            const selectAllBtn = document.getElementById('select-all-btn');
            selectAllBtn.textContent = checkedCount === userPlaylists.length ? 'Deselect All' : 'Select All';
        }

        async function generatePlaylist() {
            const btn = document.getElementById('generate-btn');
            const playlistDiv = document.getElementById('playlist');

            // Get selected playlist IDs
            const selectedCheckboxes = document.querySelectorAll('#playlist-selector input[type="checkbox"]:checked');
            const selectedPlaylistIds = Array.from(selectedCheckboxes).map(cb => cb.value);

            btn.disabled = true;
            btn.textContent = 'Generating...';
            playlistDiv.innerHTML = '<p>Analyzing your music library and weather...</p>';
            playlistDiv.classList.remove('hidden');

            try {
                const response = await fetch('/api/recommendations/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        activity: currentActivity, // Use selected activity
                        queue_size: 10,
                        playlist_ids: selectedPlaylistIds.length > 0 ? selectedPlaylistIds : null,
                        parameter_weights: parameterWeights // Send custom weights
                    })
                });

                const data = await response.json();

                if (data.error) {
                    playlistDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                } else {
                    window.currentPlaylist = data.recommendations;
                    candidatePool = data.candidate_pool || [];  // Store full candidate pool for expansion
                    console.log(`Loaded ${window.currentPlaylist.length} recommendations with ${candidatePool.length} candidates in pool`);

                    renderPlaylist();
                    initializePlayer();
                }
            } catch (error) {
                console.error('Failed to generate playlist:', error);
                playlistDiv.innerHTML = '<p>Failed to generate playlist. Please try again.</p>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Playlist';
            }
        }

        function renderPlaylist() {
            const playlistDiv = document.getElementById('playlist');

            if (!window.currentPlaylist || window.currentPlaylist.length === 0) {
                playlistDiv.innerHTML = '<p>No tracks in playlist</p>';
                return;
            }

            let html = '';
            window.currentPlaylist.forEach((track, index) => {
                const trackId = track.id || track.uri?.split(':')[2];
                const artists = Array.isArray(track.artists)
                    ? track.artists.map(a => a.name || a).join(', ')
                    : (track.artist || 'Unknown Artist');
                const score = track.score !== undefined ? track.score.toFixed(2) : 'N/A';

                html += `
                    <div class="track-item" id="track-${index}" onclick="playTrack('${trackId}', ${index})">
                        <strong>${index + 1}. ${track.name || 'Unknown Track'}</strong> - ${artists}
                        <span style="float: right; color: #666;">Score: ${score}</span>
                    </div>
                `;
            });

            playlistDiv.innerHTML = html;
        }

        async function recordListeningBehavior(trackId, genres, completionPercentage) {
            try {
                const response = await fetch('/api/behavior/track', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        track_id: trackId,
                        genres: genres,
                        completion_percentage: completionPercentage
                    })
                });

                const data = await response.json();
                if (data.success) {
                    console.log(`Behavior recorded: ${(completionPercentage * 100).toFixed(1)}% completion`);
                    console.log('Updated genre scores:', data.genre_scores);
                    console.log('Skip threshold:', data.skip_threshold);
                    return data;
                }
            } catch (error) {
                console.error('Failed to record behavior:', error);
            }
            return null;
        }

        async function expandQueue() {
            if (candidatePool.length === 0) {
                console.log('No candidates available for queue expansion');
                return;
            }

            try {
                // Re-score the candidate pool with updated preferences
                const response = await fetch('/api/recommendations/rescore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        candidates: candidatePool
                    })
                });

                const data = await response.json();

                if (data.success && data.next_track) {
                    const nextTrack = data.next_track;

                    // Add the highest scoring track to the playlist
                    window.currentPlaylist.push(nextTrack);
                    console.log(`Added to queue: ${nextTrack.name} (score: ${nextTrack.score.toFixed(2)})`);

                    // Remove the added track from candidate pool to avoid duplicates
                    const addedTrackId = nextTrack.id;
                    candidatePool = candidatePool.filter(track => track.id !== addedTrackId);
                    console.log(`Candidate pool updated: ${candidatePool.length} tracks remaining`);

                    // Re-render the playlist
                    renderPlaylist();
                }
            } catch (error) {
                console.error('Failed to expand queue:', error);
            }
        }

        // Spotify Web Playback SDK Integration
        let player;
        let deviceId;
        let currentTrackIndex = 0;
        let accessToken;
        let isAutoPlaying = false; // Flag to prevent multiple auto-play triggers
        let lastTrackUri = null; // Track the last played track to detect changes
        let trackStartTime = null; // Track when current song started
        let currentPlayingTrack = null; // Currently playing track object
        let candidatePool = []; // Full candidate pool for dynamic expansion

        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log('Spotify SDK Ready');
        };

        async function getAccessToken() {
            const response = await fetch('/api/auth/token');
            const data = await response.json();
            return data.access_token;
        }

        async function initializePlayer() {
            if (player) {
                console.log('Player already initialized');
                return;
            }

            accessToken = await getAccessToken();

            player = new Spotify.Player({
                name: 'Adaptive Music System',
                getOAuthToken: cb => { cb(accessToken); },
                volume: 0.5
            });

            // Ready
            player.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);
                deviceId = device_id;
                document.getElementById('player').classList.remove('hidden');
            });

            // Not Ready
            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
            });

            // Player State Changed
            player.addListener('player_state_changed', state => {
                if (!state) return;

                updatePlayerUI(state);
                updateProgress(state);

                const currentTrack = state.track_window.current_track;
                const currentTrackUri = currentTrack ? currentTrack.uri : null;

                // Detect track change
                if (currentTrackUri !== lastTrackUri) {
                    // Record behavior for previous track if it exists
                    if (lastTrackUri && trackStartTime && currentPlayingTrack) {
                        const playDuration = Date.now() - trackStartTime;
                        const trackDuration = currentPlayingTrack.duration_ms || state.duration;
                        const completionPercentage = Math.min(playDuration / trackDuration, 1.0);

                        // Get genres from the track
                        const genres = [];
                        if (currentPlayingTrack.artists) {
                            currentPlayingTrack.artists.forEach(artist => {
                                if (artist.genres) {
                                    genres.push(...artist.genres);
                                }
                            });
                        }

                        const trackId = currentPlayingTrack.id || lastTrackUri.split(':')[2];
                        recordListeningBehavior(trackId, genres, completionPercentage);
                    }

                    // Update tracking for new track
                    lastTrackUri = currentTrackUri;
                    trackStartTime = Date.now();
                    currentPlayingTrack = window.currentPlaylist[currentTrackIndex];
                    isAutoPlaying = false; // Reset auto-play flag on track change

                    // Expand queue when next track starts playing
                    expandQueue();
                }

                // Auto-play next track when current track ends
                // Track has ended when position is 0, paused is true, and we're not at the start
                const trackEnded = state.position === 0 &&
                                   state.paused &&
                                   state.track_window.previous_tracks.length > 0;

                if (trackEnded && !isAutoPlaying && window.currentPlaylist && currentTrackIndex < window.currentPlaylist.length - 1) {
                    console.log('Track ended, playing next track...');
                    isAutoPlaying = true; // Set flag to prevent multiple triggers
                    setTimeout(() => {
                        nextTrack();
                    }, 500); // Small delay to ensure state is settled
                }
            });

            // Connect to the player
            player.connect();
        }

        function updatePlayerUI(state) {
            const track = state.track_window.current_track;
            const isPaused = state.paused;

            document.getElementById('track-name').textContent = track.name;
            document.getElementById('track-artist').textContent = track.artists.map(a => a.name).join(', ');
            document.getElementById('album-art').src = track.album.images[0].url;
            document.getElementById('play-pause-btn').textContent = isPaused ? '‚ñ∂' : '‚è∏';
            document.getElementById('duration').textContent = formatTime(track.duration_ms);
        }

        function updateProgress(state) {
            const position = state.position;
            const duration = state.duration;
            const percent = (position / duration) * 100;

            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('current-time').textContent = formatTime(position);
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        async function playTrack(trackId, index) {
            if (!deviceId) {
                alert('Player not ready yet. Please wait a moment.');
                return;
            }

            currentTrackIndex = index;
            currentPlayingTrack = window.currentPlaylist[index]; // Store full track data
            trackStartTime = Date.now(); // Mark when track starts

            // Update UI to show playing track
            document.querySelectorAll('.track-item').forEach(item => item.classList.remove('playing'));
            document.getElementById(`track-${index}`).classList.add('playing');

            const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                    uris: [`spotify:track:${trackId}`]
                })
            });

            if (!response.ok) {
                console.error('Failed to play track:', await response.text());
            }
        }

        async function togglePlay() {
            player.togglePlay();
        }

        async function nextTrack() {
            if (currentTrackIndex < window.currentPlaylist.length - 1) {
                const nextIndex = currentTrackIndex + 1;
                const nextTrack = window.currentPlaylist[nextIndex];
                const trackId = nextTrack.id || nextTrack.uri?.split(':')[2];
                playTrack(trackId, nextIndex);
            }
        }

        async function previousTrack() {
            if (currentTrackIndex > 0) {
                const prevIndex = currentTrackIndex - 1;
                const prevTrack = window.currentPlaylist[prevIndex];
                const trackId = prevTrack.id || prevTrack.uri?.split(':')[2];
                playTrack(trackId, prevIndex);
            }
        }

        function setVolume(value) {
            if (player) {
                player.setVolume(value / 100);
            }
        }

        function seek(event) {
            if (!player) return;
            const progressBar = event.currentTarget;
            const clickPosition = event.offsetX;
            const width = progressBar.offsetWidth;
            const percent = clickPosition / width;

            player.getCurrentState().then(state => {
                if (state) {
                    player.seek(state.duration * percent);
                }
            });
        }

        // Update progress bar every second
        setInterval(() => {
            if (player) {
                player.getCurrentState().then(state => {
                    if (state) {
                        updateProgress(state);
                    }
                });
            }
        }, 1000);

        // Check auth status when page loads
        window.addEventListener('DOMContentLoaded', checkAuth);

        // Also check if redirected from OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('auth') === 'success') {
            // Clear the URL parameter and check auth
            window.history.replaceState({}, document.title, window.location.pathname);
            checkAuth();
        }
    </script>
</body>
</html>