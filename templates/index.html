<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive Music System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 40px; }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .btn {
            background: #1DB954;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #1ed760; }
        .btn:disabled { background: #666; cursor: not-allowed; }
        .hidden { display: none; }
        .loading { opacity: 0.6; pointer-events: none; }
        #weather-info { margin: 20px 0; }
        #playlist { max-height: 400px; overflow-y: auto; }
        .track-item {
            padding: 10px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .track-item:hover {
            background: #e0e0e0;
        }
        .track-item.playing {
            background: #1DB954;
            color: white;
        }
        #player {
            background: #282828;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        #player-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        #album-art {
            width: 64px;
            height: 64px;
            border-radius: 5px;
            margin-right: 15px;
            background: #404040;
        }
        #track-info {
            flex: 1;
        }
        #track-name {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        #track-artist {
            color: #b3b3b3;
            font-size: 0.9em;
        }
        #player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }
        #player-controls button {
            background: transparent;
            border: 1px solid white;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #player-controls button:hover {
            background: rgba(255,255,255,0.1);
        }
        #player-controls .play-btn {
            width: 50px;
            height: 50px;
            font-size: 1.5em;
        }
        #progress-bar {
            width: 100%;
            height: 4px;
            background: #404040;
            border-radius: 2px;
            cursor: pointer;
            margin: 10px 0;
        }
        #progress {
            height: 100%;
            background: #1DB954;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }
        #time-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #b3b3b3;
        }
        #volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        #volume-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: #404040;
            border-radius: 2px;
        }
        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
        }
    </style>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ Adaptive Music System</h1>
            <p>Weather-Aware Music Recommendations</p>
        </header>
        <div class="card">
            <h2>Spotify Authentication</h2>
            <div id="login-section">
                <p>Connect your Spotify account to get started</p>
                <button class="btn" onclick="login()">Login with Spotify</button>
            </div>
            <div id="logout-section" class="hidden">
                <p>Connected to Spotify</p>
                <button class="btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="app-section" class="hidden">
            <div class="card">
                <h2>Current Weather</h2>
                <div id="weather-info">
                    <p>Loading weather data...</p>
                </div>
            </div>

            <div class="card">
                <h2>Music Player</h2>
                <div id="player" class="hidden">
                    <div id="player-info">
                        <img id="album-art" src="" alt="Album Art">
                        <div id="track-info">
                            <div id="track-name">No track playing</div>
                            <div id="track-artist"></div>
                        </div>
                    </div>
                    <div id="player-controls">
                        <button onclick="previousTrack()" title="Previous">‚èÆ</button>
                        <button class="play-btn" onclick="togglePlay()" id="play-pause-btn" title="Play/Pause">‚ñ∂</button>
                        <button onclick="nextTrack()" title="Next">‚è≠</button>
                    </div>
                    <div id="progress-bar" onclick="seek(event)">
                        <div id="progress"></div>
                    </div>
                    <div id="time-info">
                        <span id="current-time">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                    <div id="volume-control">
                        <span>üîä</span>
                        <input type="range" id="volume-slider" min="0" max="100" value="50" oninput="setVolume(this.value)">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Generate Weather-Aware Playlist</h2>
                <p>Create a playlist tailored to your current weather and mood</p>
                <button class="btn" onclick="generatePlaylist()" id="generate-btn">Generate Playlist</button>
                <div id="playlist" class="hidden"></div>
            </div>
        </div>
    </div>
    <script>
        // Check authentication status on page load
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();

                if (data.authenticated) {
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('logout-section').classList.remove('hidden');
                    document.getElementById('app-section').classList.remove('hidden');
                    loadWeather();
                } else {
                    document.getElementById('login-section').classList.remove('hidden');
                    document.getElementById('logout-section').classList.add('hidden');
                    document.getElementById('app-section').classList.add('hidden');
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
        }

        async function login() {
            const response = await fetch('/api/auth/login');
            const data = await response.json();
            window.location.href = data.auth_url;
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            location.reload();
        }

        async function loadWeather() {
            try {
                const response = await fetch('/api/weather/current');
                const data = await response.json();

                const weatherDiv = document.getElementById('weather-info');
                if (data.error) {
                    weatherDiv.innerHTML = `<p>Weather data unavailable: ${data.error}</p>`;
                } else {
                    weatherDiv.innerHTML = `
                        <p><strong>Location:</strong> ${data.location.city}, ${data.location.country}</p>
                        <p><strong>Temperature:</strong> ${data.weather.temperature}¬∞F</p>
                        <p><strong>Conditions:</strong> ${data.weather.description}</p>
                        <p><strong>Humidity:</strong> ${data.weather.humidity}%</p>
                    `;
                }
            } catch (error) {
                console.error('Failed to load weather:', error);
                document.getElementById('weather-info').innerHTML = '<p>Failed to load weather data</p>';
            }
        }

        async function generatePlaylist() {
            const btn = document.getElementById('generate-btn');
            const playlistDiv = document.getElementById('playlist');

            btn.disabled = true;
            btn.textContent = 'Generating...';
            playlistDiv.innerHTML = '<p>Analyzing your music library and weather...</p>';
            playlistDiv.classList.remove('hidden');

            try {
                const response = await fetch('/api/recommendations/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        activity: 'relaxing',
                        queue_size: 10
                    })
                });

                const data = await response.json();

                if (data.error) {
                    playlistDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                } else {
                    window.currentPlaylist = data.recommendations;
                    let html = '<h3>Your Weather-Aware Playlist:</h3>';
                    data.recommendations.forEach((track, i) => {
                        const trackId = track.id || track.uri?.split(':')[2];
                        html += `
                            <div class="track-item" onclick="playTrack('${trackId}', ${i})" id="track-${i}">
                                ${i + 1}. <strong>${track.name}</strong> by ${track.artists.join(', ')}
                                <br><small>Score: ${track.score.toFixed(2)}</small>
                            </div>
                        `;
                    });
                    playlistDiv.innerHTML = html;
                    initializePlayer();
                }
            } catch (error) {
                console.error('Failed to generate playlist:', error);
                playlistDiv.innerHTML = '<p>Failed to generate playlist. Please try again.</p>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Playlist';
            }
        }

        // Spotify Web Playback SDK Integration
        let player;
        let deviceId;
        let currentTrackIndex = 0;
        let accessToken;

        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log('Spotify SDK Ready');
        };

        async function getAccessToken() {
            const response = await fetch('/api/auth/token');
            const data = await response.json();
            return data.access_token;
        }

        async function initializePlayer() {
            if (player) {
                console.log('Player already initialized');
                return;
            }

            accessToken = await getAccessToken();

            player = new Spotify.Player({
                name: 'Adaptive Music System',
                getOAuthToken: cb => { cb(accessToken); },
                volume: 0.5
            });

            // Ready
            player.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);
                deviceId = device_id;
                document.getElementById('player').classList.remove('hidden');
            });

            // Not Ready
            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
            });

            // Player State Changed
            player.addListener('player_state_changed', state => {
                if (!state) return;

                updatePlayerUI(state);
                updateProgress(state);
            });

            // Connect to the player
            player.connect();
        }

        function updatePlayerUI(state) {
            const track = state.track_window.current_track;
            const isPaused = state.paused;

            document.getElementById('track-name').textContent = track.name;
            document.getElementById('track-artist').textContent = track.artists.map(a => a.name).join(', ');
            document.getElementById('album-art').src = track.album.images[0].url;
            document.getElementById('play-pause-btn').textContent = isPaused ? '‚ñ∂' : '‚è∏';
            document.getElementById('duration').textContent = formatTime(track.duration_ms);
        }

        function updateProgress(state) {
            const position = state.position;
            const duration = state.duration;
            const percent = (position / duration) * 100;

            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('current-time').textContent = formatTime(position);
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        async function playTrack(trackId, index) {
            if (!deviceId) {
                alert('Player not ready yet. Please wait a moment.');
                return;
            }

            currentTrackIndex = index;

            // Update UI to show playing track
            document.querySelectorAll('.track-item').forEach(item => item.classList.remove('playing'));
            document.getElementById(`track-${index}`).classList.add('playing');

            const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                    uris: [`spotify:track:${trackId}`]
                })
            });

            if (!response.ok) {
                console.error('Failed to play track:', await response.text());
            }
        }

        async function togglePlay() {
            player.togglePlay();
        }

        async function nextTrack() {
            if (currentTrackIndex < window.currentPlaylist.length - 1) {
                const nextIndex = currentTrackIndex + 1;
                const nextTrack = window.currentPlaylist[nextIndex];
                const trackId = nextTrack.id || nextTrack.uri?.split(':')[2];
                playTrack(trackId, nextIndex);
            }
        }

        async function previousTrack() {
            if (currentTrackIndex > 0) {
                const prevIndex = currentTrackIndex - 1;
                const prevTrack = window.currentPlaylist[prevIndex];
                const trackId = prevTrack.id || prevTrack.uri?.split(':')[2];
                playTrack(trackId, prevIndex);
            }
        }

        function setVolume(value) {
            if (player) {
                player.setVolume(value / 100);
            }
        }

        function seek(event) {
            if (!player) return;
            const progressBar = event.currentTarget;
            const clickPosition = event.offsetX;
            const width = progressBar.offsetWidth;
            const percent = clickPosition / width;

            player.getCurrentState().then(state => {
                if (state) {
                    player.seek(state.duration * percent);
                }
            });
        }

        // Update progress bar every second
        setInterval(() => {
            if (player) {
                player.getCurrentState().then(state => {
                    if (state) {
                        updateProgress(state);
                    }
                });
            }
        }, 1000);

        // Check auth status when page loads
        window.addEventListener('DOMContentLoaded', checkAuth);

        // Also check if redirected from OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('auth') === 'success') {
            // Clear the URL parameter and check auth
            window.history.replaceState({}, document.title, window.location.pathname);
            checkAuth();
        }
    </script>
</body>
</html>